---
title: "Working with 288 data"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Below is an example showing the entire process of using the `chars_` functions to update characteristics data using an ADDCHARS extract.

```{r, message=FALSE, results='asis'}
library(ccao)
library(dplyr)
library(tidyr)
library(knitr)

# Choose a random sample PIN from the sample ADDCHARS data
sample_chars <- chars_sample_addchars %>%
  filter(QU_PIN == "09254040180000")

# This PIN has additional bedrooms, bathrooms, and an additional story added
# Note that this also updates the class
sample_chars %>%
  select(
    QU_PIN, TAX_YEAR,
    QU_BEDS, QU_FULL_BATH, QU_TYPE_OF_RES, QU_CLASS
  ) %>%
  kable(format = "markdown", digits = 3)

# Sparsify the data, converting it from a single row with a start year to a row
# for each year the 288 is active
sparse_chars <- sample_chars %>%
  chars_sparsify(
    pin_col = QU_PIN,
    year_col = TAX_YEAR, 
    town_col = as.character(QU_TOWN),
    upload_date_col = QU_UPLOAD_DATE,
    additive_source = any_of(chars_cols$add_source),
    replacement_source = any_of(chars_cols$rep_source)
  )

# The resulting sparse data can be joined onto any data containing CCAOSFCHARS
sparse_chars %>%
  select(
    QU_PIN, YEAR, QU_BEDS, QU_FULL_BATH,
    QU_TYPE_OF_RES, QU_CLASS, NUM_288S_ACTIVE
  ) %>%
  kable(format = "markdown", digits = 3)

# Using an example dataset included in the package we can merge the 288 data
# and then use the chars_update() function to update the relevant PIN
updated_chars <- chars_sample_universe %>%
  filter(PIN %in% sample_chars$QU_PIN) %>%
  left_join(
    sparse_chars,
    by = c("PIN" = "QU_PIN", "TAX_YEAR" = "YEAR")
  ) %>%
  arrange(PIN, TAX_YEAR) %>%
  chars_update(
    additive_target = any_of(ccao::chars_cols$add_target),
    replacement_target = any_of(ccao::chars_cols$rep_target)
  )

# Here are the characteristics as updated by the 288 (2013 is not updated, 2020
# is updated)
updated_chars %>%
  ungroup() %>%
  select(
    PIN, TAX_YEAR, CLASS, 
    BEDS, ROOMS, TYPE_RESD, FBATH, NUM_288S_ACTIVE
  ) %>%
  arrange(PIN, CLASS, TAX_YEAR) %>%
  kable(format = "markdown", digits = 3)

```
